"""
Global configuration for Numerology RAG System
Основная конфигурация для системы RAG по нумерологии
"""
import os
from pathlib import Path
from typing import Dict, Any

# ============================================================================
# ПУТИ (PATHS)
# ============================================================================
PROJECT_ROOT = Path(__file__).parent.parent
DATA_DIR = PROJECT_ROOT / "data"
PDF_DIR = DATA_DIR / "pdfs"
PROCESSED_DIR = DATA_DIR / "processed"
MODELS_DIR = DATA_DIR / "models"
LOGS_DIR = PROJECT_ROOT / "logs"

# Создание папок если их нет
for directory in [DATA_DIR, PDF_DIR, PROCESSED_DIR, MODELS_DIR, LOGS_DIR]:
    directory.mkdir(parents=True, exist_ok=True)

# ============================================================================
# ОСНОВНЫЕ ПАРАМЕТРЫ (CORE SETTINGS)
# ============================================================================
PROJECT_NAME = "numerology-kz-rag-system"
VERSION = "1.0.0"
LANGUAGE = "ru"  # Русский язык

# ============================================================================
# БАЗА ДАННЫХ (DATABASE)
# ============================================================================
DB_HOST = os.getenv("DB_HOST", "localhost")
DB_PORT = int(os.getenv("DB_PORT", "5432"))
DB_NAME = os.getenv("DB_NAME", "numerology_rag")
DB_USER = os.getenv("DB_USER", "postgres")
DB_PASSWORD = os.getenv("DB_PASSWORD", "postgres")

DATABASE_URL = f"postgresql://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}"

# ============================================================================
# МОДЕЛИ (MODELS)
# ============================================================================
# Embeddings модель
EMBEDDINGS_MODEL = "intfloat/multilingual-e5-base"  # 768D, многоязычная
EMBEDDINGS_DEVICE = "auto"  # auto, cpu, cuda
EMBEDDINGS_BATCH_SIZE = 32

# LLM модель
LLM_MODEL = "qwen2:8b"  # Qwen2 8B
LLM_API_BASE = os.getenv("LLM_API_BASE", "http://localhost:11434")
LLM_MAX_TOKENS = 512  # Максимум токенов в ответе
LLM_TEMPERATURE = 0.7
LLM_TIMEOUT = 9  # Таймаут 9 сек (меньше чем лимит 10 сек)

# ============================================================================
# RETRIEVAL ПАРАМЕТРЫ (RETRIEVAL SETTINGS)
# ============================================================================
# BM25 поиск
BM25_TOP_K = 10  # Количество документов для BM25

# Векторный поиск
FAISS_TOP_K = 5  # Количество документов для FAISS
VECTOR_SIMILARITY_THRESHOLD = 0.5  # Минимальный cosine similarity

# Гибридный поиск
HYBRID_TOP_K = 5  # Финальные результаты после reranking
RERANK_THRESHOLD = 0.4

# ============================================================================
# CHUNKING ПАРАМЕТРЫ (CHUNKING SETTINGS)
# ============================================================================
CHUNK_SIZE = 512  # Размер чанка в токенах
CHUNK_OVERLAP = 100  # Перекрытие между чанками

# ============================================================================
# OCR ПАРАМЕТРЫ (OCR SETTINGS)
# ============================================================================
OCR_LANG = "rus"  # Русский язык для OCR (Tesseract)
OCR_DPI = 150  # DPI для преобразования PDF в изображение
OCR_THREADS = 4  # Количество потоков OCR

# ============================================================================
# API ПАРАМЕТРЫ (API SETTINGS)
# ============================================================================
API_HOST = "0.0.0.0"
API_PORT = 8000
API_DEBUG = os.getenv("DEBUG", "False").lower() == "true"

# ============================================================================
# TELEGRAM БОТ (TELEGRAM BOT)
# ============================================================================
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN", "YOUR_TOKEN_HERE")
TELEGRAM_MAX_MESSAGE_LENGTH = 4096  # Лимит Telegram

# ============================================================================
# ЛОГИРОВАНИЕ (LOGGING)
# ============================================================================
LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
LOG_FORMAT = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# ============================================================================
# PROMPTS (СИСТЕМНЫЕ ПОДСКАЗКИ)
# ============================================================================
SYSTEM_PROMPT = """
Ты помощник специалист по нумерологии. Ты работаешь с научной литературой по нумерологии и давай ответы на основе источников.

ПРАВИЛА:
1. Давай ответы ТОЛЬКО на основе предоставленных источников
2. Если информация не в источниках - скажи "К сожалению, я не нашел информацию об этом в доступных источниках"
3. Всегда цитируй источник и номер страницы
4. Максимум 512 токенов в ответе
5. Ответ на русском языке

Источники будут предоставлены в формате:
[ИСТОЧНИК 1]
Название: {название}
Страница: {номер}
Текст: {текст}
[/ИСТОЧНИК 1]"""

RETRIEVAL_PROMPT_TEMPLATE = """
На основе следующих источников ответь на вопрос:

ВОПРОС: {query}

ИСТОЧНИКИ:
{context}

Ответь на русском языке. Обязательно указывай источники и номера страниц.
"""

# ============================================================================
# ПАРАМЕТРЫ ПРОИЗВОДИТЕЛЬНОСТИ (PERFORMANCE)
# ============================================================================
CACHE_EMBEDDINGS = True  # Кэшировать embeddings
BATCH_PROCESSING = True  # Батч-обработка
MAX_WORKERS = 4  # Максимум рабочих потоков